{% extends 'base.html.twig' %}

{% block title %}Gestion des Classes - Administration{% endblock %}

{% block body %}
<div class="flex h-screen w-full overflow-hidden">
    <!-- Sidebar Component -->
    {% include 'components/_sidebar.html.twig' with {
        'roleLabel': 'Admin Panel',
        'activeMenu': 'classes',
        'menuItems': [
            {'id': 'dashboard', 'route': 'admin_dashboard', 'icon': 'dashboard', 'label': 'Tableau de bord'},
            {'id': 'students', 'route': 'admin_dashboard', 'icon': 'school', 'label': 'Dossiers Élèves'},
            {'id': 'teachers', 'route': 'admin_dashboard', 'icon': 'work', 'label': 'Enseignants'},
            {'id': 'classes', 'route': 'admin_classes', 'icon': 'domain', 'label': 'Classes'}
        ]
    } %}

    <!-- Main Content -->
    <main class="flex flex-1 flex-col overflow-hidden bg-background-light dark:bg-background-dark">
        <!-- Navbar Component -->
        {% include 'components/_navbar.html.twig' with {
            'pageTitle': 'Gestion des Classes',
            'user': app.user
        } %}

        <!-- Scrollable Page Content -->
        <div class="flex-1 overflow-y-auto p-4 lg:p-10">
            <div class="mx-auto flex max-w-[1400px] flex-col gap-8">
                {# Header & Actions #}
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
                    <div>
                        <p class="text-[#9eb7a8] text-sm font-medium mb-1">Administration / Classes</p>
                        <h1 class="text-3xl md:text-4xl font-black text-slate-900 dark:text-white tracking-tight">Gestion des Classes</h1>
                    </div>
                    <button class="flex items-center justify-center gap-2 bg-primary text-black hover:bg-white transition-colors h-12 px-6 rounded-full font-bold shadow-[0_0_20px_rgba(56,224,123,0.3)] hover:shadow-[0_0_30px_rgba(56,224,123,0.5)] active:scale-95 transform duration-200">
                        <span class="material-symbols-outlined">add_circle</span>
                        <span>Nouvelle Classe</span>
                    </button>
                </div>

                {# Filters & Toolbar #}
                <div class="bg-white dark:bg-surface-dark rounded-2xl p-4 flex flex-col md:flex-row gap-4 items-center border border-slate-200 dark:border-[#29382f]">
                    {# Search within page #}
                    <div class="flex-1 w-full">
                        <div class="relative w-full">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="material-symbols-outlined text-[#9eb7a8] text-[20px]">search</span>
                            </div>
                            <input id="searchInput" class="block w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary text-sm transition-colors" placeholder="Rechercher par nom de classe ou enseignant..." type="text"/>
                        </div>
                    </div>
                    {# Filters #}
                    <div class="flex gap-3 w-full md:w-auto">
                        <div class="relative min-w-[160px] flex-1 md:flex-none">
                            <select id="levelFilter" class="appearance-none w-full bg-slate-50 dark:bg-[#122017] text-slate-900 dark:text-white border border-slate-200 dark:border-[#29382f] rounded-lg py-2.5 pl-4 pr-10 focus:border-primary focus:ring-1 focus:ring-primary text-sm cursor-pointer">
                                <option value="">Tous les niveaux</option>
                                <option value="6ème">6ème</option>
                                <option value="5ème">5ème</option>
                                <option value="4ème">4ème</option>
                                <option value="3ème">3ème</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-[#9eb7a8]">
                                <span class="material-symbols-outlined text-sm">expand_more</span>
                            </div>
                        </div>
                        <button id="listViewBtn" class="flex items-center justify-center size-10 rounded-lg border border-slate-200 dark:border-[#29382f] text-[#9eb7a8] hover:text-slate-900 dark:hover:text-white hover:border-slate-300 dark:hover:border-white/20 bg-slate-50 dark:bg-[#122017] transition-all" title="Vue Liste">
                            <span class="material-symbols-outlined">format_list_bulleted</span>
                        </button>
                        <button id="gridViewBtn" class="flex items-center justify-center size-10 rounded-lg border border-primary text-primary bg-primary/10 transition-all" title="Vue Grille">
                            <span class="material-symbols-outlined">grid_view</span>
                        </button>
                    </div>
                </div>

                {# Cards Grid - Dynamic #}
                <div id="classesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    {% set gradients = [
                        'from-blue-500 to-indigo-600',
                        'from-emerald-500 to-teal-600',
                        'from-purple-500 to-pink-600',
                        'from-orange-500 to-red-600',
                        'from-indigo-500 to-purple-600',
                        'from-cyan-500 to-blue-600',
                        'from-pink-500 to-rose-600',
                        'from-teal-500 to-emerald-600'
                    ] %}
                    
                    {% set badgeColors = [
                        'blue',
                        'emerald',
                        'purple',
                        'orange',
                        'indigo',
                        'cyan',
                        'pink',
                        'teal'
                    ] %}

                    {% for classe in classes %}
                        {% set gradientIndex = loop.index0 % gradients|length %}
                        {% set badgeColor = badgeColors[gradientIndex] %}
                        
                        <div class="class-card group relative bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-[#29382f] hover:border-primary/50 hover:shadow-lg hover:shadow-primary/5 p-4 sm:p-6 transition-all duration-300 flex flex-col gap-4 sm:gap-6" 
                             data-class-name="{{ classe.nom|lower }}" 
                             data-class-level="{{ classe.niveau|lower }}"
                             data-teacher-name="{{ (classe.teacher_prenom|default('') ~ ' ' ~ classe.teacher_nom|default(''))|lower }}">
                            <div class="flex justify-between items-start">
                                <div class="flex gap-3 sm:gap-4 items-center">
                                    <div class="size-10 sm:size-12 rounded-xl bg-gradient-to-br {{ gradients[gradientIndex] }} flex items-center justify-center text-white shadow-lg">
                                        <span class="font-bold text-base sm:text-lg">{{ classe.nom|slice(0, 2)|upper }}</span>
                                    </div>
                                    <div>
                                        <h3 class="text-slate-900 dark:text-white text-lg sm:text-xl font-bold leading-tight group-hover:text-primary transition-colors">{{ classe.nom }}</h3>
                                        <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-{{ badgeColor }}-500/10 text-{{ badgeColor }}-400 border border-{{ badgeColor }}-500/20">{{ classe.niveau }}</span>
                                    </div>
                                </div>
                                <button class="text-[#9eb7a8] hover:text-slate-900 dark:hover:text-white p-1 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                                    <span class="material-symbols-outlined">more_vert</span>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
                                <div class="bg-slate-50 dark:bg-[#122017] rounded-xl p-2.5 sm:p-3 flex items-center gap-2 sm:gap-3 border border-slate-200 dark:border-[#29382f]">
                                    <div class="p-1.5 sm:p-2 bg-slate-200 dark:bg-[#29382f] rounded-lg text-primary">
                                        <span class="material-symbols-outlined text-[18px] sm:text-[20px]">groups</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-[10px] text-[#9eb7a8] uppercase font-bold tracking-wider">Élèves</span>
                                        <span class="text-slate-900 dark:text-white font-bold text-base sm:text-lg">{{ classe.student_count|default(0) }}</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 dark:bg-[#122017] rounded-xl p-2.5 sm:p-3 flex items-center gap-2 sm:gap-3 border border-slate-200 dark:border-[#29382f]">
                                    <div class="p-1.5 sm:p-2 bg-slate-200 dark:bg-[#29382f] rounded-lg text-orange-400">
                                        <span class="material-symbols-outlined text-[18px] sm:text-[20px]">event_seat</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-[10px] text-[#9eb7a8] uppercase font-bold tracking-wider">Année</span>
                                        <span class="text-slate-900 dark:text-white font-bold text-base sm:text-lg">{{ classe.annee_scolaire|default('N/A') }}</span>
                                    </div>
                                </div>
                                <div class="bg-slate-50 dark:bg-[#122017] rounded-xl p-2.5 sm:p-3 flex items-center gap-2 sm:gap-3 border border-slate-200 dark:border-[#29382f] sm:col-span-2 lg:col-span-1">
                                    <div class="p-1.5 sm:p-2 bg-slate-200 dark:bg-[#29382f] rounded-lg text-purple-400">
                                        <span class="material-symbols-outlined text-[18px] sm:text-[20px]">menu_book</span>
                                    </div>
                                    <div class="flex flex-col min-w-0 flex-1">
                                        <span class="text-[10px] text-[#9eb7a8] uppercase font-bold tracking-wider">Matière</span>
                                        <span class="text-slate-900 dark:text-white font-bold text-sm truncate">{{ classe.matiere_libelle|default('N/A') }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-[#29382f]">
                                <div class="flex items-center gap-3">
                                    {% if classe.teacher_nom and classe.teacher_prenom %}
                                        <div class="size-8 rounded-full bg-primary text-background-dark flex items-center justify-center font-bold text-sm ring-2 ring-background-light dark:ring-background-dark">
                                            {{ classe.teacher_prenom|first }}{{ classe.teacher_nom|first }}
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-slate-900 dark:text-white text-sm font-medium">{{ classe.teacher_prenom }} {{ classe.teacher_nom }}</span>
                                            <span class="text-[10px] text-[#9eb7a8]">Prof. Principal</span>
                                        </div>
                                    {% else %}
                                        <div class="flex items-center gap-2 text-[#9eb7a8] text-sm">
                                            <span class="material-symbols-outlined text-[18px]">person_off</span>
                                            <span>Aucun enseignant</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0 duration-300">
                                    <button class="size-8 rounded-full flex items-center justify-center bg-slate-200 dark:bg-[#29382f] text-slate-900 dark:text-white hover:bg-primary hover:text-black transition-colors" title="Modifier">
                                        <span class="material-symbols-outlined text-[18px]">edit</span>
                                    </button>
                                    <button class="size-8 rounded-full flex items-center justify-center bg-slate-200 dark:bg-[#29382f] text-slate-900 dark:text-white hover:bg-red-500 hover:text-white transition-colors" title="Supprimer">
                                        <span class="material-symbols-outlined text-[18px]">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
                            <div class="size-20 rounded-full bg-slate-100 dark:bg-[#29382f] flex items-center justify-center mb-4">
                                <span class="material-symbols-outlined text-4xl text-[#9eb7a8]">meeting_room</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Aucune classe trouvée</h3>
                            <p class="text-[#9eb7a8] mb-6">Commencez par créer votre première classe</p>
                            <button class="flex items-center gap-2 bg-primary text-black hover:bg-white transition-colors h-10 px-5 rounded-full font-bold">
                                <span class="material-symbols-outlined text-[20px]">add_circle</span>
                                <span>Créer une classe</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>

                {# Footer / Pagination #}
                {% if classes|length > 0 %}
                    <div class="flex items-center justify-between mt-4 pb-8">
                        <p id="paginationInfo" class="text-sm text-[#9eb7a8]">Affichage de <span class="text-slate-900 dark:text-white font-bold">1-{{ classes|length > 20 ? 20 : classes|length }}</span> sur <span class="text-slate-900 dark:text-white font-bold">{{ classes|length }}</span> classe(s)</p>
                        <div class="flex gap-2">
                            <button id="prevPageBtn" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-[#29382f] text-slate-900 dark:text-white text-sm font-medium hover:bg-primary hover:text-black disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>Précédent</button>
                            <button id="nextPageBtn" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-[#29382f] text-slate-900 dark:text-white text-sm font-medium hover:bg-primary hover:text-black disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Suivant</button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const levelFilter = document.getElementById('levelFilter');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const classesGrid = document.getElementById('classesGrid');
    const classCards = Array.from(document.querySelectorAll('.class-card'));
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Pagination state
    let currentPage = 1;
    const itemsPerPage = 20;
    let filteredCards = [...classCards];
    
    // Filter function
    function filterClasses() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedLevel = levelFilter.value.toLowerCase();
        
        // Filter all cards
        filteredCards = classCards.filter(card => {
            const className = card.dataset.className;
            const classLevel = card.dataset.classLevel;
            const teacherName = card.dataset.teacherName || '';
            
            // Search in both class name and teacher name
            const matchesSearch = !searchTerm || 
                                  className.includes(searchTerm) || 
                                  teacherName.includes(searchTerm);
            const matchesLevel = !selectedLevel || classLevel === selectedLevel;
            
            return matchesSearch && matchesLevel;
        });
        
        // Reset to page 1 when filtering
        currentPage = 1;
        
        // Apply pagination
        paginateResults();
    }
    
    // Paginate results
    function paginateResults() {
        const totalItems = filteredCards.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        
        // Hide all cards first
        classCards.forEach(card => {
            card.style.display = 'none';
        });
        
        // Show only cards for current page
        const cardsToShow = filteredCards.slice(startIndex, endIndex);
        cardsToShow.forEach(card => {
            card.style.display = '';
        });
        
        // Update pagination info
        updatePaginationInfo(startIndex, endIndex, totalItems);
        
        // Update button states
        updatePaginationButtons(totalPages);
        
        // Show/hide empty state
        showEmptyState(totalItems === 0);
    }
    
    // Update pagination info text
    function updatePaginationInfo(startIndex, endIndex, totalItems) {
        if (totalItems === 0) {
            paginationInfo.innerHTML = 'Affichage de <span class="text-slate-900 dark:text-white font-bold">0</span> sur <span class="text-slate-900 dark:text-white font-bold">0</span> classe(s)';
        } else {
            const start = startIndex + 1;
            const end = Math.min(endIndex, totalItems);
            paginationInfo.innerHTML = `Affichage de <span class="text-slate-900 dark:text-white font-bold">${start}-${end}</span> sur <span class="text-slate-900 dark:text-white font-bold">${totalItems}</span> classe(s)`;
        }
    }
    
    // Update pagination button states
    function updatePaginationButtons(totalPages) {
        // Disable/enable Previous button
        prevPageBtn.disabled = currentPage === 1;
        
        // Disable/enable Next button
        nextPageBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }
    
    // Show/hide empty state
    function showEmptyState(show) {
        let emptyState = document.getElementById('emptyState');
        
        if (show && !emptyState) {
            emptyState = document.createElement('div');
            emptyState.id = 'emptyState';
            emptyState.className = 'col-span-full flex flex-col items-center justify-center py-16 text-center';
            emptyState.innerHTML = `
                <div class="size-20 rounded-full bg-slate-100 dark:bg-[#29382f] flex items-center justify-center mb-4">
                    <span class="material-symbols-outlined text-4xl text-[#9eb7a8]">search_off</span>
                </div>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Aucune classe trouvée</h3>
                <p class="text-[#9eb7a8] mb-6">Essayez de modifier vos critères de recherche</p>
            `;
            classesGrid.appendChild(emptyState);
        } else if (!show && emptyState) {
            emptyState.remove();
        }
    }
    
    // Navigate to previous page
    function goToPreviousPage() {
        if (currentPage > 1) {
            currentPage--;
            paginateResults();
            // Scroll to top of grid
            classesGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    // Navigate to next page
    function goToNextPage() {
        const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            paginateResults();
            // Scroll to top of grid
            classesGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    // Toggle view mode
    function setViewMode(mode) {
        if (mode === 'list') {
            classesGrid.classList.remove('grid-cols-1', 'md:grid-cols-2', 'xl:grid-cols-3');
            classesGrid.classList.add('grid-cols-1');
            
            // Update button states
            listViewBtn.classList.add('border-primary', 'text-primary', 'bg-primary/10');
            listViewBtn.classList.remove('border-slate-200', 'dark:border-[#29382f]', 'text-[#9eb7a8]', 'bg-slate-50', 'dark:bg-[#122017]');
            
            gridViewBtn.classList.remove('border-primary', 'text-primary', 'bg-primary/10');
            gridViewBtn.classList.add('border-slate-200', 'dark:border-[#29382f]', 'text-[#9eb7a8]', 'bg-slate-50', 'dark:bg-[#122017]');
        } else {
            classesGrid.classList.remove('grid-cols-1');
            classesGrid.classList.add('grid-cols-1', 'md:grid-cols-2', 'xl:grid-cols-3');
            
            // Update button states
            gridViewBtn.classList.add('border-primary', 'text-primary', 'bg-primary/10');
            gridViewBtn.classList.remove('border-slate-200', 'dark:border-[#29382f]', 'text-[#9eb7a8]', 'bg-slate-50', 'dark:bg-[#122017]');
            
            listViewBtn.classList.remove('border-primary', 'text-primary', 'bg-primary/10');
            listViewBtn.classList.add('border-slate-200', 'dark:border-[#29382f]', 'text-[#9eb7a8]', 'bg-slate-50', 'dark:bg-[#122017]');
        }
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterClasses);
    levelFilter.addEventListener('change', filterClasses);
    prevPageBtn.addEventListener('click', goToPreviousPage);
    nextPageBtn.addEventListener('click', goToNextPage);
    gridViewBtn.addEventListener('click', () => setViewMode('grid'));
    listViewBtn.addEventListener('click', () => setViewMode('list'));
    
    // Initialize pagination on page load
    paginateResults();
});
</script>
{% endblock %}