{% extends 'base.html.twig' %}

{% block title %}Gestion des Élèves - Admin Scolaire{% endblock %}

{% block body %}
<div class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display antialiased overflow-hidden h-screen flex">
    <!-- Sidebar -->
    {{ include('components/_sidebar.html.twig') }}

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Top Navigation -->
        {{ include('components/_navbar.html.twig') }}

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
            <div class="max-w-[1400px] mx-auto space-y-8">
                <!-- Page Heading -->
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-black tracking-tight text-slate-900 dark:text-white mb-2">
                            Gestion des Élèves
                        </h1>
                        <p class="text-slate-500 dark:text-[#9eb7a8] text-lg">
                            Année Scolaire {{ currentYear|default('2023-2024') }}
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button class="hidden md:flex items-center gap-2 px-6 py-3 bg-surface-light dark:bg-[#1a2621] text-slate-700 dark:text-white border border-slate-200 dark:border-[#29382f] rounded-full hover:bg-slate-50 dark:hover:bg-[#23302a] transition-colors shadow-sm font-bold text-sm">
                            <span class="material-symbols-outlined text-[20px]">upload_file</span>
                            <span>Importer</span>
                        </button>
                        <button class="flex items-center gap-2 px-6 py-3 bg-primary text-[#111714] rounded-full hover:bg-[#2ec568] transition-colors shadow-lg shadow-primary/20 font-bold text-sm">
                            <span class="material-symbols-outlined text-[20px]">add</span>
                            <span>Ajouter un élève</span>
                        </button>
                    </div>
                </div>

                <!-- Filters & Search Bar -->
                <div class="bg-surface-light dark:bg-[#1a2621] p-4 rounded-xl border border-slate-200 dark:border-[#29382f] shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between">
                    <div class="relative w-full md:w-96 group">
                        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                        <input class="w-full h-12 pl-12 pr-4 bg-slate-50 dark:bg-[#111714] border-none rounded-full text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5e7065] focus:ring-2 focus:ring-primary transition-all" placeholder="Rechercher par nom, classe..." type="text"/>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                        <div class="relative min-w-[160px]">
                            <select id="levelFilter" onchange="window.location.href = '{{ path('admin_eleves') }}?niveau=' + this.value" class="appearance-none w-full h-12 pl-4 pr-10 bg-slate-50 dark:bg-[#111714] border-none rounded-full text-slate-700 dark:text-[#9eb7a8] font-medium focus:ring-2 focus:ring-primary cursor-pointer">
                                <option value="">Toutes les classes</option>
                                {% for level in levels %}
                                    <option value="{{ level }}" {% if currentNiveau == level %}selected{% endif %}>{{ level }}</option>
                                {% endfor %}
                            </select>
                            <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                        </div>
                        <div class="relative min-w-[160px]">
                            <select class="appearance-none w-full h-12 pl-4 pr-10 bg-slate-50 dark:bg-[#111714] border-none rounded-full text-slate-700 dark:text-[#9eb7a8] font-medium focus:ring-2 focus:ring-primary cursor-pointer">
                                <option value="">Tous les statuts</option>
                                <option value="actif">Actif</option>
                                <option value="absent">Absent</option>
                                <option value="radie">Radié</option>
                            </select>
                            <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                        </div>
                        <button class="h-12 w-12 flex items-center justify-center bg-slate-50 dark:bg-[#111714] rounded-full text-slate-500 dark:text-[#9eb7a8] hover:text-primary hover:bg-primary/10 transition-colors shrink-0 tooltip" title="Réinitialiser">
                            <span class="material-symbols-outlined">filter_alt_off</span>
                        </button>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="bg-surface-light dark:bg-[#1a2621] rounded-2xl border border-slate-200 dark:border-[#29382f] shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 dark:bg-[#111714]/50 border-b border-slate-200 dark:border-[#29382f]">
                                    <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-[#9eb7a8]">Élève</th>
                                    <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-[#9eb7a8]">ID</th>
                                    <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-[#9eb7a8]">Classe</th>
                                    <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-[#9eb7a8]">Statut</th>
                                    <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-[#9eb7a8] text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-[#29382f]">
                                {% for item in students %}
                                    <tr class="group hover:bg-slate-50 dark:hover:bg-[#23302a] transition-colors">
                                        <td class="py-4 px-6">
                                            <div class="flex items-center gap-4">
                                                <div class="h-10 w-10 rounded-full bg-slate-200 dark:bg-[#29382f] overflow-hidden shrink-0 flex items-center justify-center text-slate-500">
                                                    {% if false %}
                                                        <img alt="{{ item.eleve.prenom }} {{ item.eleve.nom }}" class="h-full w-full object-cover" src="https://ui-avatars.com/api/?name={{ item.eleve.prenom }}+{{ item.eleve.nom }}&background=random"/>
                                                    {% else %}
                                                        <span class="font-bold text-xs">{{ item.eleve.prenom|first }}{{ item.eleve.nom|first }}</span>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <p class="font-bold text-slate-900 dark:text-white">{{ item.eleve.prenom }} {{ item.eleve.nom }}</p>
                                                    <p class="text-xs text-slate-500 dark:text-[#9eb7a8]">{{ item.eleve.email }}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-4 px-6 text-sm text-slate-600 dark:text-slate-300 font-mono">
                                            #{{ item.eleve.numeroInscription|default('N/A') }}
                                        </td>
                                        <td class="py-4 px-6">
                                            {% if item.classe %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                                                    {{ item.classe.nom }}
                                                </span>
                                            {% else %}
                                                <span class="text-slate-400 italic text-sm">Non inscrit</span>
                                            {% endif %}
                                        </td>
                                        <td class="py-4 px-6">
                                            {% if item.statut == 'radie' %}
                                                <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400 border border-red-200 dark:border-red-800/30">
                                                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 dark:bg-red-400"></span>
                                                    Radié
                                                </div>
                                            {% elseif item.statut == 'absent' %}
                                                <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400 border border-amber-200 dark:border-amber-700/30">
                                                    <span class="w-1.5 h-1.5 rounded-full bg-amber-500 dark:bg-amber-400"></span>
                                                    Absent
                                                </div>
                                            {% else %}
                                                <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 dark:bg-primary/20 dark:text-primary border border-green-200 dark:border-primary/20">
                                                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 dark:bg-primary"></span>
                                                    {% if item.statut %}{{ item.statut|capitalize }}{% else %}Inscrit{% endif %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="py-4 px-6 text-right">
                                            <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-[#29382f] text-slate-500 dark:text-[#9eb7a8] transition-colors" title="Voir profil">
                                                    <span class="material-symbols-outlined text-[20px]">visibility</span>
                                                </button>
                                                <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-[#29382f] text-primary transition-colors" title="Éditer">
                                                    <span class="material-symbols-outlined text-[20px]">edit</span>
                                                </button>
                                                <button onclick="openDeleteModal('{{ item.eleve.id }}', '{{ item.eleve.nom }}', '{{ item.eleve.prenom }}')" class="p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 hover:text-red-600 transition-colors" title="Supprimer">
                                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="py-8 text-center text-slate-500 dark:text-[#9eb7a8]">
                                            Aucun élève trouvé.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                {% if pagination.totalPages > 1 %}
                <div class="bg-surface-light dark:bg-[#1a2621] rounded-xl border border-slate-200 dark:border-[#29382f] shadow-sm p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-slate-600 dark:text-[#9eb7a8]">
                        Affichage de <span class="font-bold text-slate-900 dark:text-white">{{ ((pagination.page - 1) * pagination.limit) + 1 }}</span> à <span class="font-bold text-slate-900 dark:text-white">{{ min(pagination.page * pagination.limit, pagination.total) }}</span> sur <span class="font-bold text-slate-900 dark:text-white">{{ pagination.total }}</span> élève(s)
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="{{ path('admin_eleves', {'page': pagination.page - 1, 'niveau': currentNiveau}) }}" 
                           class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-50 dark:bg-[#111714] text-slate-700 dark:text-[#9eb7a8] hover:bg-slate-100 dark:hover:bg-[#29382f] transition-colors font-medium text-sm {% if pagination.page <= 1 %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}">
                            <span class="material-symbols-outlined text-[18px]">chevron_left</span>
                            <span>Précédent</span>
                        </a>
                        
                        <div class="flex items-center gap-1">
                            {% for pageNum in range(max(1, pagination.page - 2), min(pagination.totalPages, pagination.page + 2)) %}
                                {% if pageNum == pagination.page %}
                                    <span class="px-4 py-2 rounded-full bg-primary text-[#111714] font-bold text-sm">{{ pageNum }}</span>
                                {% else %}
                                    <a href="{{ path('admin_eleves', {'page': pageNum, 'niveau': currentNiveau}) }}" class="px-4 py-2 rounded-full bg-slate-50 dark:bg-[#111714] text-slate-700 dark:text-[#9eb7a8] hover:bg-slate-100 dark:hover:bg-[#29382f] transition-colors font-medium text-sm">{{ pageNum }}</a>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        <a href="{{ path('admin_eleves', {'page': pagination.page + 1, 'niveau': currentNiveau}) }}" 
                           class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-50 dark:bg-[#111714] text-slate-700 dark:text-[#9eb7a8] hover:bg-slate-100 dark:hover:bg-[#29382f] transition-colors font-medium text-sm {% if pagination.page >= pagination.totalPages %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}">
                            <span>Suivant</span>
                            <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                        </a>
                    </div>
                </div>
                {% endif %}
                        </table>
                    </div>
                </div>
                
                <footer class="mt-12 text-center text-xs text-slate-400 dark:text-[#5e7065] pb-8">
                    © 2024 Système de Gestion Scolaire v2.4. Tous droits réservés.
                </footer>
            </div>
        </div>
    </main>
</div>

{# Delete Confirmation Modal #}
<div id="deleteConfirmationModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-[#29382f] max-w-md w-full shadow-2xl overflow-hidden">
        <div class="p-6 text-center">
            <div class="size-14 rounded-full bg-red-100 dark:bg-red-500/20 text-red-500 flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-3xl">warning</span>
            </div>
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Confirmer la suppression</h3>
            <p class="text-slate-500 dark:text-[#9eb7a8] text-sm mb-6">
                Êtes-vous sûr de vouloir supprimer l'élève <span id="deleteStudentName" class="font-bold text-slate-900 dark:text-white"></span> ?
                <br><br>
                <span class="text-xs italic text-red-500 dark:text-red-400 font-bold">ATTENTION : Cette action est irréversible. Toutes les notes et inscriptions associées seront supprimées.</span>
            </p>
            
            <div class="flex gap-3 justify-center">
                <button id="cancelDeleteBtn" class="px-5 py-2.5 rounded-lg border border-slate-200 dark:border-[#29382f] text-slate-700 dark:text-white font-medium hover:bg-slate-50 dark:hover:bg-white/10 transition-colors">
                    Annuler
                </button>
                <button id="confirmDeleteBtn" class="px-5 py-2.5 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30">
                    Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

{# Toast Notification Container #}
<div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toast Function
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `pointer-events-auto transform transition-all duration-300 translate-x-full opacity-0 flex items-start gap-3 p-4 rounded-xl shadow-2xl border max-w-md ${
            type === 'success' 
                ? 'bg-white dark:bg-surface-dark border-primary/20' 
                : 'bg-white dark:bg-surface-dark border-red-500/20'
        }`;
        
        const icon = type === 'success' ? 'check_circle' : 'error';
        const iconColor = type === 'success' ? 'text-primary' : 'text-red-500';
        const titleColor = type === 'success' ? 'text-primary' : 'text-red-500';
        const title = type === 'success' ? 'Succès' : 'Erreur';
        
        toast.innerHTML = `
            <div class="flex-shrink-0">
                <span class="material-symbols-outlined ${iconColor} text-2xl">${icon}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-bold ${titleColor}">${title}</p>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-0.5">${message}</p>
            </div>
            <button class="flex-shrink-0 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors" onclick="this.parentElement.remove()">
                <span class="material-symbols-outlined text-[20px]">close</span>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 10);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Delete Modal Logic
    const deleteModal = document.getElementById('deleteConfirmationModal');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteStudentNameSpan = document.getElementById('deleteStudentName');
    let studentIdToDelete = null;

    window.openDeleteModal = function(id, nom, prenom) {
        studentIdToDelete = id;
        deleteStudentNameSpan.textContent = `${prenom} ${nom}`;
        deleteModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        document.body.style.overflow = '';
        studentIdToDelete = null;
    }

    if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    
    // Close delete modal on click outside
    if (deleteModal) {
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) closeDeleteModal();
        });
    }

    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async function() {
            if (!studentIdToDelete) return;
            
            // Disable button
            const originalContent = confirmDeleteBtn.innerHTML;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>';
            
            try {
                const response = await fetch(`/admin/eleves/${studentIdToDelete}/delete`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(result.message, 'success');
                    closeDeleteModal();
                    // Reload to update list
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast(result.message || "Erreur lors de la suppression", 'error');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.innerHTML = originalContent;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Erreur de communication avec le serveur', 'error');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = originalContent;
            }
        });
    }
});
</script>
{% endblock %}
