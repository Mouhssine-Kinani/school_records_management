{% extends 'base.html.twig' %}

{% block title %}Gestion des Enseignants - Système Scolaire{% endblock %}

{% block body %}
<div class="flex h-screen w-full overflow-hidden">
    <!-- Sidebar -->
    {% include 'components/_sidebar.html.twig' %}

    <div class="flex-1 flex flex-col min-w-0 bg-background-light dark:bg-background-dark overflow-hidden">
        <!-- Navbar -->
        {% include 'components/_navbar.html.twig' %}

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto w-full">
            <div class="max-w-7xl mx-auto px-6 py-8 flex flex-col gap-8">
            <!-- Page Heading -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div class="flex flex-col gap-2">
                    <h2 class="text-4xl font-black text-slate-900 dark:text-white tracking-tight">
                        Gestion des Enseignants
                    </h2>
                    <p class="text-slate-500 dark:text-[#9eb7a8] text-lg">
                        Vue d'ensemble et administration du corps professoral
                    </p>
                </div>
            </div>

            <!-- Control Bar (Search, Filters, Action) -->
            <div class="flex flex-col lg:flex-row items-center justify-between gap-4 bg-white dark:bg-surface-dark/50 p-2 rounded-full border border-slate-200 dark:border-[#29382f]">
                <!-- Search -->
                <div class="relative w-full lg:w-96 group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 dark:text-[#9eb7a8] group-focus-within:text-primary transition-colors">
                        <span class="material-symbols-outlined">search</span>
                    </div>
                    <input
                        class="block w-full pl-12 pr-4 py-3 bg-transparent border-transparent text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#9eb7a8] rounded-full focus:border-primary focus:bg-slate-50 dark:focus:bg-[#25332b] focus:ring-0 sm:text-sm transition-all"
                        placeholder="Rechercher par nom, email..."
                        type="text"
                    />
                </div>

                <!-- Filters -->
                <div class="flex items-center gap-2 overflow-x-auto w-full lg:w-auto px-2 lg:px-0 scrollbar-hide">
                    <button class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-slate-100 dark:bg-[#25332b] text-slate-700 dark:text-white text-sm font-medium whitespace-nowrap hover:bg-slate-200 dark:hover:bg-[#2f4236] transition-colors border border-transparent hover:border-primary/30">
                        <span>Matière</span>
                        <span class="material-symbols-outlined text-[18px]">expand_more</span>
                    </button>
                    <button class="flex items-center gap-2 px-4 py-2.5 rounded-full bg-slate-100 dark:bg-[#25332b] text-slate-700 dark:text-white text-sm font-medium whitespace-nowrap hover:bg-slate-200 dark:hover:bg-[#2f4236] transition-colors border border-transparent hover:border-primary/30">
                        <span>Statut: Actif</span>
                        <span class="material-symbols-outlined text-[18px]">expand_more</span>
                    </button>
                </div>

                <!-- Primary Action -->
                <button id="openModalBtn" class="w-full lg:w-auto flex items-center justify-center gap-2 bg-primary hover:bg-[#2ccb69] text-background-dark px-6 py-3 rounded-full font-bold transition-all shadow-lg shadow-primary/20 hover:shadow-primary/40">
                    <span class="material-symbols-outlined">add</span>
                    <span class="whitespace-nowrap">Ajouter un enseignant</span>
                </button>
            </div>

            <!-- Data Table Card -->
            <div class="bg-white dark:bg-surface-dark rounded-[2rem] border border-slate-200 dark:border-[#29382f] overflow-hidden flex flex-col shadow-xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-200 dark:border-[#29382f] bg-slate-50 dark:bg-[#151f19]">
                                <th class="px-8 py-5 text-slate-500 dark:text-[#9eb7a8] text-sm font-medium uppercase tracking-wider w-16">
                                    <div class="flex items-center justify-center">
                                        <input class="rounded border-slate-400 dark:border-[#9eb7a8] bg-transparent text-primary focus:ring-0 focus:ring-offset-0 size-4" type="checkbox" />
                                    </div>
                                </th>
                                <th class="px-6 py-5 text-slate-500 dark:text-[#9eb7a8] text-sm font-medium uppercase tracking-wider">
                                    Nom &amp; Prénom
                                </th>
                                <th class="px-6 py-5 text-slate-500 dark:text-[#9eb7a8] text-sm font-medium uppercase tracking-wider">
                                    Email &amp; Contact
                                </th>
                                <th class="px-6 py-5 text-slate-500 dark:text-[#9eb7a8] text-sm font-medium uppercase tracking-wider">
                                    Matières Enseignées
                                </th>
                                <th class="px-6 py-5 text-slate-500 dark:text-[#9eb7a8] text-sm font-medium uppercase tracking-wider text-right">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-[#29382f]">
                            {% for enseignant in enseignants %}
                            <tr class="group hover:bg-slate-50 dark:hover:bg-[#25332b] transition-colors cursor-pointer">
                                <td class="px-8 py-4">
                                    <div class="flex items-center justify-center">
                                        <input class="rounded border-slate-400 dark:border-[#9eb7a8] bg-transparent text-primary focus:ring-0 focus:ring-offset-0 size-4" type="checkbox" />
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-4">
                                        <div class="size-10 rounded-full bg-primary text-background-dark font-bold flex items-center justify-center border border-slate-200 dark:border-[#29382f]">
                                            {{ enseignant.prenom|first }}{{ enseignant.nom|first }}
                                        </div>
                                        <div>
                                            <p class="text-slate-900 dark:text-white font-medium text-base group-hover:text-primary transition-colors">
                                                {{ enseignant.nom }}, {{ enseignant.prenom }}
                                            </p>
                                            <p class="text-slate-500 dark:text-[#9eb7a8] text-xs">
                                                ID: #T-{{ "now"|date("Y") }}-{{ enseignant.id|format('%03d') }}
                                            </p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex flex-col gap-1">
                                        <div class="flex items-center gap-2 text-slate-500 dark:text-[#9eb7a8] group-hover:text-slate-900 dark:group-hover:text-white transition-colors">
                                            <span class="material-symbols-outlined text-[16px]">mail</span>
                                            <span class="text-sm">{{ enseignant.email }}</span>
                                        </div>
                                        {% if enseignant.telephone %}
                                        <div class="flex items-center gap-2 text-slate-400 dark:text-[#9eb7a8]/70 text-xs">
                                            <span class="material-symbols-outlined text-[14px]">call</span>
                                            <span>{{ enseignant.telephone }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex flex-wrap gap-2">
                                        {% if enseignant.specialite %}
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary border border-primary/20">
                                                {{ enseignant.specialite }}
                                            </span>
                                        {% else %}
                                            <span class="text-slate-400 dark:text-[#9eb7a8]/50 text-xs italic">Non spécifié</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center justify-end gap-2 opacity-70 group-hover:opacity-100 transition-opacity">
                                        <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-background-dark text-slate-500 dark:text-[#9eb7a8] hover:text-primary transition-colors" title="Voir">
                                            <span class="material-symbols-outlined text-[20px]">visibility</span>
                                        </button>
                                        <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-background-dark text-slate-500 dark:text-[#9eb7a8] hover:text-primary transition-colors" title="Éditer">
                                            <span class="material-symbols-outlined text-[20px]">edit</span>
                                        </button>
                                        <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-background-dark text-slate-500 dark:text-[#9eb7a8] hover:text-red-400 transition-colors" title="Supprimer">
                                            <span class="material-symbols-outlined text-[20px]">delete</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-slate-500 dark:text-[#9eb7a8]">
                                    Aucun enseignant trouvé.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination (Placeholder) -->
                {% if enseignants|length > 0 %}
                <div class="bg-white dark:bg-surface-dark border-t border-slate-200 dark:border-[#29382f] px-6 py-4 flex items-center justify-between">
                    <span class="text-sm text-slate-500 dark:text-[#9eb7a8]">
                        Affichage de <span class="text-slate-900 dark:text-white font-medium">1</span> à <span class="text-slate-900 dark:text-white font-medium">{{ enseignants|length }}</span> sur <span class="text-slate-900 dark:text-white font-medium">{{ enseignants|length }}</span> enseignants
                    </span>
                    <div class="flex items-center gap-2">
                        <button class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-[#25332b] text-slate-500 dark:text-[#9eb7a8] disabled:opacity-50 transition-colors" disabled>
                            <span class="material-symbols-outlined text-[20px]">chevron_left</span>
                        </button>
                        <button class="size-8 rounded-full bg-primary text-background-dark font-bold text-sm flex items-center justify-center">
                            1
                        </button>
                        <button class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-[#25332b] text-slate-500 dark:text-[#9eb7a8] transition-colors" disabled>
                            <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            </div>
        </main>
    </div>
</div>

{# Toast Notification Container #}
<div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none"></div>

{# Modal for Creating New Enseignant #}
<div id="createEnseignantModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-[#29382f] max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
        {# Modal Header #}
        <div class="sticky top-0 bg-white dark:bg-surface-dark border-b border-slate-200 dark:border-[#29382f] p-6 flex items-center justify-between z-10">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white shadow-lg">
                    <span class="material-symbols-outlined">person_add</span>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-slate-900 dark:text-white">Nouvel Enseignant</h2>
                    <p class="text-sm text-[#9eb7a8]">Ajouter un nouveau membre au corps professoral</p>
                </div>
            </div>
            <button id="closeModalBtn" class="text-[#9eb7a8] hover:text-slate-900 dark:hover:text-white p-2 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        {# Modal Body #}
        <form id="createEnseignantForm" class="p-6 space-y-6">
            {# Personal Info Section #}
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">badge</span>
                    Informations Personnelles
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {# Nom #}
                    <div>
                        <label for="nom" class="block text-sm font-bold text-slate-900 dark:text-white mb-2">
                            Nom <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="nom" name="nom" required
                               class="w-full px-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
                               placeholder="Ex: Dupont">
                    </div>
                    {# Prénom #}
                    <div>
                        <label for="prenom" class="block text-sm font-bold text-slate-900 dark:text-white mb-2">
                            Prénom <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="prenom" name="prenom" required
                               class="w-full px-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
                               placeholder="Ex: Jean">
                    </div>
                </div>

                {# Email #}
                <div>
                    <label for="email" class="block text-sm font-bold text-slate-900 dark:text-white mb-2">
                        Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
                           placeholder="Ex: jean.dupont@ecole.com">
                </div>

                {# Telephone #}
                 <div>
                    <label for="telephone" class="block text-sm font-bold text-slate-900 dark:text-white mb-2">
                        Téléphone
                    </label>
                    <input type="tel" id="telephone" name="telephone"
                           class="w-full px-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
                           placeholder="Ex: 06 12 34 56 78">
                </div>
            </div>

            {# Professional Info Section #}
            <div class="space-y-4 pt-4 border-t border-slate-200 dark:border-[#29382f]">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">school</span>
                    Informations Professionnelles
                </h3>
                
                {# Specialité #}
                <div>
                    <label for="specialite" class="block text-sm font-bold text-slate-900 dark:text-white mb-2">
                        Spécialité / Matière principale
                    </label>
                    <input type="text" id="specialite" name="specialite"
                           class="w-full px-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
                           placeholder="Ex: Mathématiques">
                </div>
            </div>

            {# Security Section #}
            <div class="space-y-4 pt-4 border-t border-slate-200 dark:border-[#29382f]">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">lock</span>
                    Sécurité
                </h3>
                
                {# Mot de passe #}
                <div>
                    <label for="mot_de_passe" class="block text-sm font-bold text-slate-900 dark:text-white mb-2">
                        Mot de passe provisoire <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input type="password" id="mot_de_passe" name="mot_de_passe" required
                               class="w-full px-4 py-2.5 bg-slate-50 dark:bg-[#122017] border border-slate-200 dark:border-[#29382f] rounded-lg text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-[#5a7063] focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
                               placeholder="Minimum 6 caractères">
                        <button type="button" onclick="const i=document.getElementById('mot_de_passe'); i.type = i.type==='password'?'text':'password'" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white">
                             <span class="material-symbols-outlined text-[20px]">visibility</span>
                        </button>
                    </div>
                </div>
            </div>

            {# Modal Footer #}
            <div class="flex gap-3 pt-6 border-t border-slate-200 dark:border-[#29382f]">
                <button type="button" id="cancelBtn" 
                        class="flex-1 px-6 py-2.5 rounded-lg border border-slate-200 dark:border-[#29382f] text-slate-900 dark:text-white font-bold hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                    Annuler
                </button>
                <button type="submit" id="submitBtn"
                        class="flex-1 px-6 py-2.5 rounded-lg bg-primary text-black font-bold hover:bg-white transition-colors shadow-[0_0_20px_rgba(56,224,123,0.3)] hover:shadow-[0_0_30px_rgba(56,224,123,0.5)] flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>Créer l'enseignant</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modal Elements
    const modal = document.getElementById('createEnseignantModal');
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const form = document.getElementById('createEnseignantForm');
    const submitBtn = document.getElementById('submitBtn');
    const toastContainer = document.getElementById('toastContainer');

    // Toast Function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `pointer-events-auto transform transition-all duration-300 translate-x-full opacity-0 flex items-start gap-3 p-4 rounded-xl shadow-2xl border max-w-md ${
            type === 'success' 
                ? 'bg-white dark:bg-surface-dark border-primary/20' 
                : 'bg-white dark:bg-surface-dark border-red-500/20'
        }`;
        
        const icon = type === 'success' ? 'check_circle' : 'error';
        const iconColor = type === 'success' ? 'text-primary' : 'text-red-500';
        const titleColor = type === 'success' ? 'text-primary' : 'text-red-500';
        const title = type === 'success' ? 'Succès' : 'Erreur';
        
        toast.innerHTML = `
            <div class="flex-shrink-0">
                <span class="material-symbols-outlined ${iconColor} text-2xl">${icon}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-bold ${titleColor}">${title}</p>
                <p class="text-sm text-slate-600 dark:text-slate-300 mt-0.5">${message}</p>
            </div>
            <button class="flex-shrink-0 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors" onclick="this.parentElement.remove()">
                <span class="material-symbols-outlined text-[20px]">close</span>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 10);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // Modal Actions
    function openModal() {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        form.reset();
        
        // Reset button
        submitBtn.disabled = false;
        const msgSpan = submitBtn.querySelector('span:not(.material-symbols-outlined)');
        if(msgSpan) msgSpan.textContent = "Créer l'enseignant";
    }

    if (openModalBtn) openModalBtn.addEventListener('click', openModal);
    if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
    
    // Close on click outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    // Close on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    });

    // Form Submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Disable submit button
        submitBtn.disabled = true;
        const originalBtnContent = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span><span>Création en cours...</span>';

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('{{ path('admin_create_enseignant') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast(result.message, 'success');
                closeModal();
                // Reload to show new teacher
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(result.message || "Une erreur est survenue", 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Erreur de communication avec le serveur', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnContent;
        }
    });
});
</script>
{% endblock %}
